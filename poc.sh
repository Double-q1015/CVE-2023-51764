#!/usr/bin/expect

set timeout 10
set host "smtp.163.com"
set port 25
#163 Email verification code
set auth_code ""
# This username is used for mail server authentication
set username ""
# Email recipient, real email address
set recipient_email ""
# fake sender
set fake_sender ""
# fake receiver
set fake_recipient_email ""

# Function to generate AUTH PLAIN command
proc generate_auth_plain {username password} {
    puts "username: $username"
    puts "password: $password"
    
    set auth_string [format "\0%s\0%s" $username $password]
    set encoded_auth [binary encode base64 $auth_string]
    
    puts "auth_string: $auth_string"
    puts "encoded_auth: $encoded_auth"
    
    return $encoded_auth
}

spawn telnet $host $port

expect {
    "220 *" {
        send "EHLO kali.kali\r"
        expect "250 *"

        # Authenticate using AUTH LOGIN
        set auth_plain [generate_auth_plain $username $auth_code]
        send "AUTH PLAIN $auth_plain\r"
        expect "235 Authentication successful\r"

        send "MAIL FROM: <$username>\r"

        expect "250"
        send "RCPT TO: <$recipient_email>\r"

        expect "250"
        send "data\r"

        expect "354"
        send "From: $fake_sender\r"
        sleep 1
        send "To: $fake_recipient_email\r"
        sleep 1
        send "Subject: your_subject\r"
        sleep 1
        send "\r"
        sleep 1
        send "your_content\r"
        sleep 1
        send "\r"
        sleep 1
        send ".\r"
        sleep 1
        send "quit\r"
        sleep 1
        expect "221"
    }
    timeout {
        puts "Connection timed out"
        exit 1
    }
    eof {
        puts "Connection closed unexpectedly"
        exit 1
    }
}
